# .github/workflows/plasmic.yml
name: Sync, build and deploy Plasmic app

permissions:
  contents: write
  pull-requests: write

on:
  repository_dispatch:
    types: [plasmic]

jobs:
  job:
    name: Sync, build and deploy
    runs-on: ubuntu-latest
    steps:
      - id: checkout
        name: Checking out repository...
        uses: actions/checkout@v4
        with:
          persist-credentials: false
          fetch-depth: 0

      - id: node
        name: Setting up Node v18...
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - id: cache
        name: Recovering cache...
        uses: actions/cache@v4
        with:
          key: lock-${{ hashFiles('**/package-lock.json', '**/yarn.lock') }}
          path: ${{ github.event.client_payload.data.directory }}/node_modules

      - id: init
        name: Initializing Plasmic app...
        uses: rajasekharmanda/plasmic-action@main
        with:
          run: init
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ github.event.client_payload.data.branch }}
          directory: ${{ github.event.client_payload.data.directory }}
          project_id: ${{ github.event.client_payload.data.projectId }}
          project_api_token: ${{ github.event.client_payload.data.projectApiToken }}
          platform: ${{ github.event.client_payload.data.platform }}
          language: ${{ github.event.client_payload.data.language }}
          scheme: ${{ github.event.client_payload.data.scheme }}
          title: ${{ github.event.client_payload.data.title }}
          description: ${{ github.event.client_payload.data.description }}

        Optional: uncomment to capture all HTTP(S) via a local proxy
      - name: Start tinyproxy
        run: |
          sudo apt-get update
          sudo apt-get install -y tinyproxy
          sudo sed -i 's/^Port .*/Port 8888/' /etc/tinyproxy/tinyproxy.conf
          sudo sed -i 's/^Allow .*/# Allow/' /etc/tinyproxy/tinyproxy.conf
          sudo systemctl restart tinyproxy

      - id: sync
        name: Syncing Plasmic project...
        if: ${{ github.event.client_payload.data.scheme == 'codegen' && steps.init.outputs.synced != 'true' }}
        uses: rajasekharmanda/plasmic-action@main
        env:
          # Wire-level HTTP logging
          NODE_DEBUG: http,https

          # Route through proxy if you enabled tinyproxy above
          HTTP_PROXY: http://localhost:8888
          HTTPS_PROXY: http://localhost:8888

          # Self-hosted Plasmic base host (no /api suffix)
          PLASMIC_HOST: https://ui-builder-dev.wescodevops.com
          PLASMIC_API_HOST: https://ui-builder-dev.wescodevops.com
          PLASMIC_AUTH_HOST: https://ui-builder-dev.wescodevops.com
          PLASMIC_STUDIO_HOST: https://ui-builder-dev.wescodevops.com
        with:
          run: sync
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ github.event.client_payload.data.branch }}
          directory: ${{ github.event.client_payload.data.directory }}
          project_id: ${{ github.event.client_payload.data.projectId }}
          project_api_token: ${{ github.event.client_payload.data.projectApiToken }}
          sync_action: ${{ github.event.client_payload.data.syncAction }}
          title: ${{ github.event.client_payload.data.title }}
          description: ${{ github.event.client_payload.data.description }}

      # Optional: print proxy logs if enabled
      - name: Show proxy logs
        run: |
          sudo journalctl -u tinyproxy --no-pager | tail -n 300

      - id: build
        name: Building Plasmic app...
        if: ${{ github.event.client_payload.data.publish }}
        uses: rajasekharmanda/plasmic-action@main
        with:
          run: build
          branch: ${{ github.event.client_payload.data.branch }}
          directory: ${{ github.event.client_payload.data.directory }}
          platform: ${{ github.event.client_payload.data.platform }}
      - id: pr
        name: Create or Update Pull Request using GitHub CLI
        if: ${{ steps.sync.outputs.new_branch }}
        env:
          TITLE: ${{ github.event.client_payload.data.title || 'Plasmic Sync Auto-generated PR' }}
          BODY: ${{ github.event.client_payload.data.description || format('Automated PR created by Plasmic workflow on {0}.', github.event.created_at) }}
          BASE_BRANCH: ${{ github.event.client_payload.data.branch || 'master' }}
          HEAD_BRANCH: ${{ steps.sync.outputs.new_branch }}
        run: |
          sudo apt-get update
          sudo apt-get install -y gh
          gh auth login --with-token <<< "${{ secrets.GITHUB_TOKEN }}"
          gh_pr_up() { gh pr create "$@" || gh pr edit "$@"; }
          gh_pr_up \
            --title "${TITLE}" \
            --body "${BODY}" \
            --base "${BASE_BRANCH}" \
            --head "${HEAD_BRANCH}"